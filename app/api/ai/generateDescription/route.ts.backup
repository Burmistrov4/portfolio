import { NextRequest, NextResponse } from 'next/server'
import { GoogleGenerativeAI } from '@google/generative-ai'

/**
 * @description API route to generate project description using Google Gemini AI.
 * @param {NextRequest} request The request object.
 * @returns {NextResponse} The response with AI-generated description.
 */
export async function POST(request: NextRequest) {
  let title = 'Proyecto sin título'

  try {
    const body = await request.json()
    title = body.title || title
    const notes = body.notes

    if (!title) {
      return NextResponse.json({ error: 'Title is required' }, { status: 400 })
    }

    const apiKey = process.env.GEMINI_API_KEY
    if (!apiKey) {
      console.error('GEMINI_API_KEY not found in environment variables')
      return NextResponse.json({ error: 'AI service not configured' }, { status: 500 })
    }

    const genAI = new GoogleGenerativeAI(apiKey)
    const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' })

    const prompt = `Genera una descripción detallada en español para un proyecto titulado "${title}".
${notes ? `Información adicional: ${notes}` : ''}

La descripción debe incluir:
1. Un resumen breve del proyecto
2. Las tecnologías o herramientas utilizadas
3. Las funcionalidades principales
4. El impacto o valor que aporta

Formato la respuesta como JSON con estas claves:
- summary: resumen breve (2-3 oraciones)
- detailedDescription: descripción detallada con viñetas o párrafos

Responde únicamente con el JSON válido, sin texto adicional.`

    const result = await model.generateContent(prompt)
    const response = await result.response
    const text = response.text()

    // Try to parse as JSON first
    try {
      const parsedResponse = JSON.parse(text)
      const summary = parsedResponse.summary || parsedResponse.detailedDescription || text.split('\n')[0] || `Proyecto: ${title}`
      return NextResponse.json(summary)
    } catch (parseError) {
      // If not valid JSON, extract summary from text
      console.warn('AI response not valid JSON, extracting summary')
      const summary = text.split('\n')[0] || `Proyecto: ${title}`
      return NextResponse.json(summary)
    }

  } catch (error) {
    console.error('Error generating AI description:', error)
    const errorMessage = error instanceof Error ? error.message : String(error)
    console.error('Error details:', {
      message: errorMessage,
      type: typeof error
    })

    // Return fallback response instead of error
    const fallbackResponse = `Proyecto: ${title}. Descripción generada automáticamente.`
    return NextResponse.json(fallbackResponse)
  }
}
import { NextRequest, NextResponse } from 'next/server'
import { GoogleGenerativeAI } from '@google/generative-ai'

/**
 * @description API route to generate project description using Google Gemini AI.
 * @param {NextRequest} request The request object.
 * @returns {NextResponse} The response with AI-generated description.
 */
export async function POST(request: NextRequest) {
  const body = await request.json()
  const { title, technologies, notes, userMessage, conversationHistory } = body

  try {

    if (!title) {
      return NextResponse.json({ error: 'Title is required' }, { status: 400 })
    }

    const apiKey = process.env.GEMINI_API_KEY
    if (!apiKey) {
      console.error('GEMINI_API_KEY not found in environment variables')
      return NextResponse.json({ error: 'AI service not configured' }, { status: 500 })
    }

    const genAI = new GoogleGenerativeAI(apiKey)
    const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' })

    let prompt = `Actúa como un Escritor de Contenido Profesional para Portafolios de Desarrollo.

Contexto del proyecto:
- Título: ${title}
- Tecnologías: ${technologies?.join(', ') || 'No especificadas'}
- Notas del desarrollador: ${notes || 'No hay notas adicionales'}

`

    if (conversationHistory && conversationHistory.length > 0) {
      prompt += `Historial de conversación:
${conversationHistory.map((msg: any) => `${msg.role === 'user' ? 'Usuario' : 'Asistente'}: ${msg.content}`).join('\n')}

`
    }

    if (userMessage) {
      prompt += `Mensaje del usuario: ${userMessage}

`
    }

    prompt += `Instrucciones:
- Crea una descripción profesional de 3 párrafos (Introducción, Características Clave, Conclusión)
- Usa un tono profesional pero accesible
- Incluye detalles técnicos relevantes
- Enfatiza el valor y impacto del proyecto
- Si es una conversación continua, mejora la descripción basada en el historial y el mensaje actual

Responde con la descripción completa en español, sin formato JSON.`

    const result = await model.generateContent(prompt)
    const response = await result.response
    const text = response.text()

    return NextResponse.json({ description: text.trim() })

  } catch (error) {
    console.error('Error generating AI description:', error)
    const errorMessage = error instanceof Error ? error.message : String(error)
    console.error('Error details:', {
      message: errorMessage,
      type: typeof error
    })

    // Return fallback response instead of error
    const fallbackResponse = `Proyecto: ${body.title || 'Sin título'}. Descripción generada automáticamente.`
    return NextResponse.json({ description: fallbackResponse })
  }
}